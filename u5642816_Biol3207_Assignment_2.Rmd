---
title: "BIOL3207 Assignment 2"
author: "Kalon Peters, u5642816"
date: "28 October 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning = FALSE}
# load libraries
library(tidyverse)
library(metafor)
library(orchaRd)
library(flextable)
```

[My GitHub Repository](https://github.com/kpet0008/u5642816_Biol3207_Assignment_2)

### Q1
Correct analysis of Clark et al. (2020) data (i.e., OA_activitydat_20190302_BIOL3207.csv) to generate the summary statistics (means, SD, N) for each of the fish species’ average activity for each treatment.
```{r}
# Load the Clark et al. (2020) data file from the data folder
path <- "./data/OA_activitydat_20190302_BIOL3207.csv"
Clark <- read_csv(path)
```

```{r}
# Clean the data

# Removing missing data and turning character variables into factors
Clark_clean <- Clark %>% filter(!is.na(activity)) %>% filter(!is.na(animal_id)) %>% mutate(across(where(is.character), factor))

# Check spelling in factor variables we care about
# If no entries are misspelled, there should be 6 levels to species, and 2 to treatment
str(Clark_clean)

```

```{r}
# Create a new object which contains the summary values we're interested in
#  ie. for each species and treatment, the mean activity, SD activity, and n

# I recognise this is not the tidyest way to do this, however it matches the format of the metadata data set

Clark_summary <- bind_cols(
  unique(Clark_clean %>% group_by(species) %>% filter(treatment == "control") 
         %>% mutate(ctrl.mean = mean(activity)) 
         %>% mutate(ctrl.sd = sd(activity)) 
         %>% select(species, ctrl.mean, ctrl.sd) 
         %>% arrange(species)), 
  (ctrl.n = (Clark_clean %>% group_by(species) %>% filter(treatment == "control") 
         %>% arrange(species)
         %>% count())[,2]), 
  unique(Clark_clean %>% group_by(species) %>% filter(treatment == "CO2") 
         %>% mutate(oa.mean = mean(activity)) 
         %>% mutate(oa.sd = sd(activity)) 
         %>% select(species, oa.mean, oa.sd) 
         %>% arrange(species))[,2:3], 
  (oa.n = (Clark_clean %>% group_by(species) %>% filter(treatment == "CO2") 
         %>% arrange(species) 
         %>% count())[,2])
  )

# rename the n columns and species column, to match the broader metadata data set used later
Clark_summary <- Clark_summary %>% rename(ctrl.n = n...4, oa.n = n...7, Species = species)

# replace the abbreviated species names with their full scientific names, to match the broader metadata data set used later
# Species name: acantho = Acanthochromis polyacanthus; 
#               ambon = Pomacentrus amboinensis; 
#               chromis = Chromis atripectoralis; 
#               humbug = Dascyllus aruanus; 
#               lemon = Pomacentrus moluccensis	
#               whitedams = Dischistodus perspicillatus
levels(Clark_summary$Species) <- c('Acanthochromis polyacanthus', 'Pomacentrus amboinensis', 'Chromis atripectoralis', 'Dascyllus aruanus', 'Pomacentrus moluccensis', 'Dischistodus perspicillatus')

# convert the species factor back to a character, to match the broader metadata data set used later
# why did I make species a factor in the first place? Because it makes renaming it much cleaner, and to make it easier to find any possible spelling errors in the data.

Clark_summary <- mutate(Clark_summary, Species = as.character(Species))
```


### Q2
Through coding, merge the summary statistics generated from 1) with the metadata (i.e., clark_paper_data.csv) from Clark et al. (2020).
```{r}
# Load the Clark et al. (2020) metadata from the data folder
path <- "./data/clark_paper_data.csv"
Clark_meta <- read_csv(path)
```

```{r}
# merge the summary statistics with the metadata
Clark_meta <- bind_cols(Clark_meta, Clark_summary)
```

### Q3
Through coding, correctly merge the combined summary statistics and metadata from Clark et al. (2020) (output from 1 & 2) into the larger meta-analysis dataset (i.e., ocean_meta_data.csv).
```{r}
# Load the larger meta-analysis dataset from the data folder
path <- "./data/ocean_meta_data.csv"
meta <- read_csv(path)
```

```{r}
# A few columns need to be turned into different classes
# Additionally, NA values in the "Cue/stimulus type" column should be replaced with '-' to match the rest of the data set.
Clark_meta <- Clark_meta %>% mutate(`Pub year IF` = as.character(`Pub year IF`)) %>% mutate(`2017 IF`= as.character(`2017 IF`)) %>% mutate(`Env cue/stimulus?` = as.character(`Env cue/stimulus?`)) %>% mutate(`Cue/stimulus type` = as.character(`Cue/stimulus type`)) %>% mutate(`Cue/stimulus type` = replace_na(`Cue/stimulus type`, "-"))

str(Clark_meta)

```

```{r}
# merge the combined summary statistics and metadata from Clark et al. (2020) into the larger meta-analysis dataset

meta <- bind_rows(meta, Clark_meta)
```

### Q4
Correctly calculate the log response ratio (lnRR) effect size for every row of the dataframe using metafor’s escalc() function.
```{r}
#lnRR produces NaNs whenever the sign of ctrl.mean and oa.mean are different.
#Since these either break or are automatically excluded from future analyses, and there arent many rows like this, its easiest to just remove them now
lnrr <- meta %>% filter(ctrl.mean > 0 & oa.mean > 0 | ctrl.mean < 0 & oa.mean < 0)
lnrr <- escalc(measure="ROM", m1i = ctrl.mean, m2i = oa.mean, sd1i = ctrl.sd, sd2i = oa.sd, n1i = ctrl.n, n2i = oa.n, data=lnrr)

```

### Q5
Correct meta-analytic model fitted to the data that controls for the sampling variance of lnRR. The model should include a random effect of study and observation. Use metafor’s rma.mv() function.
```{r}
#Because the ratio of largest to smallest sampling variance extremely large, the model has a very difficult time producing a result with default settings.
#By default, rel.tol = 1e-8. To make this model actually produce a result, I've had to increase it all the way to 1e-2
#In theory I should also be able to make the model run more iterations with iter.max, to maybe get a result without changing the tolerance,
# but for some reason that's not actually making it run more iterations in practice.
MLMA <- metafor::rma.mv(yi ~ 1, V = vi, 
                   method="REML",
                   random=list(~1|Authors,
                               ~1|Study), 
                   dfs = "contain",
                   test="t",
                   data=lnrr,
                   control = list(rel.tol = 1e-2))
MLMA
```

```{r}
coef(MLMA)
MLMA$ci.lb
MLMA$ci.ub
MLMA$pval
```



### Q6
Written paragraph of the findings and what they mean which is supported with a figure. The paragraph should include:
  Correct presentation and interpretation of overall meta-analytic mean and measures of uncertainty around the mean estimate (e.g., 95% confidence intervals).

```{}
The effect size is not significantly different from 0
```

  Measures of heterogeneity in effect size estimates across studies (i.e., I2 and/or prediction intervals - see predict() function in metafor)
```{r}
#I have no idea if this is useful. It probably isnt. Remove if I dont figure it out
#predict(MLMA)

## Calculate I2
i2_vals <- orchaRd::i2_ml(MLMA)

## Make a pretty table. First, lets clean up the names of the different I2 estimates. Lets remove I2_. It's a string, so, we can use some regular expressions to fix that. `gsub` is pretty useful. You put a pattern in and tell it what you would like to replace the text with. In this case, just blank will do! Then, we'll make the first letter of what is left capitalised.
i2 <- tibble(type = firstup(gsub("I2_", "",names(i2_vals))), I2 = i2_vals)


# You remember flextable. Now, lets make a pretty table. We can so some nice modifications here too.

flextable(i2) %>% 
    align(part = "header", align = "center") %>% 
  compose(part = "header", j = 1, value = as_paragraph(as_b("Type"))) %>% 
  compose(part = "header", j = 2, value = as_paragraph(as_b("I"), as_b(as_sup("2")), as_b("(%)")))
```
 
  Forest plot showing the mean estimate, 95% confidence interval, and prediction interval with clearly labelled axes, number of samples and studies plotted on figure
```{r}
orchaRd::orchard_plot(MLMR, mod = "disp_trait", group = "study_ID", data = zr_data, xlab = "Mean Estimate", angle = 45)
```



### Q7
Funnel plot for visually assessing the possibility of publication bias.
```{r}
metafor::funnel(x = lnrr$yi, vi = abs(log(lnrr$vi)), 
               yaxis = "seinv", digits = 2,
               level = c(0.1, 0.05, 0.01),
               shade = c("white", "gray55", "gray 75"), las = 1, 
                xlab = "Correlation Coefficient (r)", atransf=tanh, legend = TRUE)
```
```{r}
ggplot(lnrr, aes(x=yi, y=abs(log(1/sqrt(vi))))) + geom_point() + xlab("Correlation Coefficient (r)") + ylab("Inverse Standard Error")
```

### This seems like it should be important but it doesnt fit in any of the questions
```{r}
ggplot(lnrr, aes(x = Average.n, y = abs(yi))) + geom_point() + ylab("Effect size magnitude (lnRR)") + xlab("Mean sample size")
```


### Q8
Time-lag plot assessing how effect sizes may or may not have changed through time.
```{r}
ggplot(lnrr, aes(x=Year..online., y=yi, size=1/sqrt(vi))) + geom_point(alpha=0.5) + geom_smooth(method = "lm", show.legend = F) + labs(size="Inverse Sampling Variance") + ylab("Effect Size")
```

### Q9
Formal meta-regression model that includes year as a moderator (fixed effect) to test for time-lag bias
```{r}
#centre the year on zero and remove the rows with an NA value since apparently they break the meta regression
lnrr_temp <-  na.omit(lnrr) %>% mutate(Year_c = mean(Year..online.) - Year..online.)

metareg_time_c <- rma.mv(yi ~ 1 + Year_c, V = vi,
                    random = list(~1|Study), 
                    test = "t", dfs = "contain", 
                    data = lnrr_temp)
summary(metareg_time_c) 
```
test for residual heterogeneity tells us there is a lot of unexplained variation left over
Test of moderators tells us that the moderators (in this case, year) are not explaining a significant amount of variation



### Q10
Formal meta-regression model that includes inverse sampling variance (i.e., 1vlnRR) to test for file-drawer biases
```{r}
metareg_time_c <- rma.mv(yi ~ 1 + (1/vi), V = vi,
                    random = list(~1|Study), 
                    test = "t", dfs = "contain", 
                    data = lnrr_temp)
summary(metareg_time_c) 
```

### Q11
A written paragraph that discusses the potential for publication bias based on the meta-regression results. What type of publication bias, if any, appears to be present in the data? If publication bias is present, what does it mean and what might be contributing to such bias?

### Q12
Identify any studies contributing to publication bias. How do your updated meta-analysis results compare with a meta-analysis by Clement et. al. (2022)? Are there any concerns about these studies? If so, describe using references to existing papers what concerns have been raised?








